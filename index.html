<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drum Step Editor</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #eee;
      padding: 20px;
    }

    .container {
      display: flex;
      align-items: flex-start;
    }

    .labels {
      display: flex;
      flex-direction: column;
      margin-right: 12px;
    }

    .label {
      line-height: 40px;
      height: 40px;
      padding-right: 8px;
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #555;
    }

    .grid {
      display: grid;
    }

    .cell {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 26px;
      box-sizing: border-box;
      border-right: 2px solid #333;
      border-bottom: 2px solid #333;
    }

    .cell.cursor-outline {
      outline: 1px solid #0f0; /* green outline for cursor */
      outline-offset: -2px;    /* inset the outline inside the cell */
    }

    #exportBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #222;
      color: #eee;
      border: 2px solid #555;
      border-radius: 5px;
    }

    #exportBtn:hover {
      background: #333;
    }

    #configForm {
      margin-top: 20px;
    }

    #configForm input {
      width: 60px;
      padding: 2px 4px;
      background-color: #333;
      color: #fff;   
    }

    #configForm button {
      padding: 5px 10px;
      cursor: pointer;
      background: #222;
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
    }

    #configForm button:hover { background: #333; }
  </style>
</head>
<body>
  <div class="container">
    <div class="labels" id="labels"></div>
    <div class="grid" id="grid"></div>
  </div>

  <button id="exportBtn">Export image</button>

  <form id="configForm">
    <label>Steps <input type="number" id="stepsInput" value="8" min="1"></label>
    <label>Group <input type="number" id="shadeInput" value="2" min="1"></label>

    <br>
    <label><input type="checkbox" name="row" value="CY" checked>CY (Cymbals)</label><br>
    <label><input type="checkbox" name="row" value="HT" checked>HT (High Tom)</label><br>
    <label><input type="checkbox" name="row" value="MT" checked>MT (Mid Tom)</label><br>
    <label><input type="checkbox" name="row" value="LT" checked>LT (Low Tom)</label><br>
    <label><input type="checkbox" name="row" value="SD" checked>SD (Snare Drum)</label><br>
    <label><input type="checkbox" name="row" value="BD" checked>BD (Bass Drum)</label><br>

    <br>
    <button type="submit">Apply</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const CONFIG = {
      steps: 8,
      shadeGroup: 2,
      cellWidth: 40,
      cellHeight: 40,
      borderColor: "#333",
      emptyColor: "#eee",
      shadeColor: "#1b1b1b",
      cursorColor: "#005200"
    };

    const ALL_ROWS = [
      { id: "CY", label: "CY", hit: "×", color: "#0a2" },
      { id: "HT", label: "HT", hit: "●", color: "#d90" },
      { id: "MT", label: "MT", hit: "●", color: "#d90" },
      { id: "LT", label: "LT", hit: "●", color: "#d90" },
      { id: "SD", label: "SD", hit: "●", color: "#00d" },
      { id: "BD", label: "BD", hit: "●", color: "#c00" } 
    ];

    const ALT_SYMBOLS = { 1: "●", 2: "×", 3: "○", 4: "✶", 5: "◇", 6: "+" };

    let ROWS = [...ALL_ROWS];
    let gridData = Array.from({ length: ROWS.length }, () => Array(CONFIG.steps).fill(""));
    let cursor = { row: 0, col: 0 };
    let cursorVisible = true;

    const labelsEl = document.getElementById("labels");
    const gridEl = document.getElementById("grid");

    function renderLabels() {
      labelsEl.innerHTML = "";
      ROWS.forEach(r => {
        const div = document.createElement("div");
        div.className = "label";
        div.textContent = r.label;
        labelsEl.appendChild(div);
      });
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      gridEl.style.gridTemplateColumns = `repeat(${CONFIG.steps}, ${CONFIG.cellWidth}px)`;
      gridEl.style.gridTemplateRows = `repeat(${ROWS.length}, ${CONFIG.cellHeight}px)`;

      for (let r = 0; r < ROWS.length; r++) {
        for (let c = 0; c < CONFIG.steps; c++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.style.width = CONFIG.cellWidth + "px";
          cell.style.height = CONFIG.cellHeight + "px";

          const shaded = Math.floor(c / CONFIG.shadeGroup) % 2 === 0;
          cell.style.background = shaded ? CONFIG.shadeColor : "#111";

          if (cursorVisible && cursor.row === r && cursor.col === c)
            cell.classList.add("cursor-outline");
          else
            cell.classList.remove("cursor-outline");

          if (r === 0) cell.style.borderTop = `2px solid ${CONFIG.borderColor}`;
          if (c === 0) cell.style.borderLeft = `2px solid ${CONFIG.borderColor}`;

          const symbol = gridData[r][c];
          cell.textContent = symbol;
          cell.style.color = symbol ? ROWS[r].color : CONFIG.emptyColor;

          gridEl.appendChild(cell);
        }
      }
    }

    function render() {
      renderLabels();
      renderGrid();
    }

    function toggleCell(symbolOverride = null) {
      const r = cursor.row;
      const c = cursor.col;
      const row = ROWS[r];
      const symbol = symbolOverride || row.hit;

      gridData[r][c] = gridData[r][c] === symbol ? "" : symbol;
      render();
    }

    document.addEventListener("keydown", e => {
      if ([" ", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key))
        e.preventDefault();

      let changed = false;
      switch (e.key) {
        case "ArrowUp": cursor.row = Math.max(0, cursor.row - 1); changed = true; break;
        case "ArrowDown": cursor.row = Math.min(ROWS.length - 1, cursor.row + 1); changed = true; break;
        case "ArrowLeft": cursor.col = Math.max(0, cursor.col - 1); changed = true; break;
        case "ArrowRight": cursor.col = Math.min(CONFIG.steps - 1, cursor.col + 1); changed = true; break;
        case " ": toggleCell(); changed = true; break;
        default:
          if (ALT_SYMBOLS[e.key]) { toggleCell(ALT_SYMBOLS[e.key]); changed = true; }
      }
      if (changed) render();
    });

    const configForm = document.getElementById("configForm");
    const stepsInput = document.getElementById("stepsInput");
    const shadeInput = document.getElementById("shadeInput");
    const rowCheckboxes = document.querySelectorAll('input[name="row"]');

    configForm.addEventListener("submit", e => {
      e.preventDefault();
      const newSteps = parseInt(stepsInput.value, 10);
      const newShade = parseInt(shadeInput.value, 10);
      if (!isNaN(newSteps) && newSteps > 0) CONFIG.steps = newSteps;
      if (!isNaN(newShade) && newShade > 0) CONFIG.shadeGroup = newShade;
      ROWS = ALL_ROWS.filter(r => {
        const cb = Array.from(rowCheckboxes).find(c => c.value === r.id);
        return cb.checked;
      });
      gridData = Array.from({ length: ROWS.length }, () => Array(CONFIG.steps).fill(""));
      cursor = { row: 0, col: 0 };
      render();
    });

    render();

    document.getElementById("exportBtn").addEventListener("click", () => {
      const original = document.querySelector(".container");
      const clone = original.cloneNode(true);
      clone.style.position = "fixed";
      clone.style.top = "-9999px";
      clone.style.left = "-9999px";
      clone.style.background = "#111";
      clone.style.padding = "10px";

      clone.querySelectorAll(".cell").forEach((el, index) => {
        const r = Math.floor(index / CONFIG.steps);
        const shaded = Math.floor(index % CONFIG.steps / CONFIG.shadeGroup) % 2 === 0;
        el.style.background = shaded ? CONFIG.shadeColor : "#111";
        el.style.color = el.textContent ? ROWS[r].color : CONFIG.emptyColor;
        el.classList.remove("cursor-outline"); // ensure cursor outline is not in export
      });

      document.body.appendChild(clone);
      html2canvas(clone, { scale: 4, backgroundColor: null, width: clone.scrollWidth, height: clone.scrollHeight }).then(canvas => {
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `drumedit-${Date.now()}.png`;
        link.click();
        clone.remove();
      });
    });
  </script>
</body>
</html>
